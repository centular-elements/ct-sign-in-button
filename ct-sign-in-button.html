<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../ct-core-utils/ct-core.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../ct-user-api/ct-user-api.html">
<link rel="import" href="../ct-core-utils/ct-core.html">
<link rel="import" href="/bower_components/ct-sign-in-button/sign-in-button-style.html">

<!--
`<ct-sign-in-button>` is used to authenticate with an API.
@demo
-->
<dom-module id="ct-sign-in-button">

  <template>
    <style include="sign-in-button-style iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
    </style>

    <ct-user-api id="userApi" ></ct-user-api>

    <app-location route="{{ route }}"></app-location>
    <app-route route="[[ route ]]" pattern="[[ _redirectPattern ]]" tail="{{ routeData }}"></app-route>

    <iron-localstorage
            id="storage"
            name="ct-auth"
            use-raw
            auto-save-disabled
            on-iron-localstorage-load="_localStorageLoaded"
            on-iron-localstorage-load-empty="_localStorageLoaded"
    ></iron-localstorage>

    <template is="dom-if" if="{{ !_signedIn }}">
      <paper-button class="sign-in-button" on-tap="_signIn">Sign in</paper-button>
    </template>

    <template is="dom-if" if="{{ _signedIn }}">
      <paper-menu-button class="user-button" horizontal-align="right" horizontal-offset="40" vertical-align="top" vertical-offset="50">
        <paper-icon-button class="dropdown-trigger" icon="icons:account-circle"></paper-icon-button>
        <div class="dropdown-content">
          <paper-card class="layout horizontal dropdown" image="[[ defaultProfilePic ]]">
            <div class="card-content">
              <a class="layout horizontal center-justified user-name">[[ _userName ]]</a>
              <paper-button class="layout horizontal center-justified my-account-button">My Account</paper-button>
            </div>
          </paper-card>
          <div class="layout vertical center-justified">
            <paper-button class="sign-out-button" on-tap="signOut">Sign out</paper-button>
          </div>
        </div>
      </paper-menu-button>

    </template>

    <ct-user-api id="usersAPI"></ct-user-api>

  </template>

  <script>
    (function () {
      var CT = window.CT;
      Polymer({
        is: 'ct-sign-in-button',
        behaviors:[CT.Behaviours.ContextCreator],
        /**
         * Fired when signed in.
         * @param {Object} detail The user object.
         * @event ct-sign-in
         */
        /**
         * Fired when there is an error during the signin flow.
         * @param {Object} detail The error object.
         * @event ct-sign-in-error
         */
        properties: {
          /**
           * Your client id obtained from client registration
           */
          clientId: String,
          /**
           * Token redirect uri you've registered for this client
           */
          tokenRedirectUri: String,
          /**
           * Authentication server location
           */
          authHostUrl: String,
          /**
           * API location
           */
          apiHostUrl: String,
          /**
           * Default profile image location
           */
          defaultProfilePic: String,
          /**
           * Location to go to after the user signed out
           */
          afterSignOutUrl: String
        },

        observers: [
          '_getRedirectUriPattern(tokenRedirectUri)',
          '_routeChanged(routeData)',
          '_getUserProfile(token, apiHostUrl)'
        ],

        _localStorageLoaded: function() {
          this._setToken(this.$.storage.value);
        },

        _getRedirectUriPattern: function() {
          this._redirectPattern = new URL(this.tokenRedirectUri).pathname;
        },
        /**
         * Sign in user. Redirects the user to authorization server for signing in.
         */
        _signIn: function() {
          window.location = [
            this.authHostUrl, '/oauth/authorise?response_type=token&client_id=', this.clientId,
            '&redirect_uri=', encodeURIComponent(this.tokenRedirectUri), '&state=0'
          ].join('');
        },

        _routeChanged: function(routeData) {
          if (routeData.prefix !== this._redirectPattern) {
            return;
          }
          if (routeData.__queryParams.access_token) {
            this._setToken(routeData.__queryParams.access_token);
          }
          // TODO handle errors
          window.history.pushState(null, '', '/');
        },

        _getUserProfile: function(token, apiHostUrl) {
          if (!token) {
            this._signedIn = false;
            return;
          }
          CT.apiHost = this.apiHostUrl;
          this.$.userApi.getUser(CT.context.userId)
                  .then(function(request) {
                    this._signedIn = true;
                    this._user = request.response;
                    this._userName = this._user.firstName + ' ' + this._user.lastName;
                    this.fire('ct-sign-in', { user: request.response, token: token });
                  }.bind(this))
                  .catch(ExpiredTokenError, function() {
                    this._signedIn = false;
                    this._setToken(null);
                    this._signIn();
                  }.bind(this))
                  .catch(function(error) {
                    this._signedIn = false;
                    this.fire('ct-sign-in-error', error);
                  }.bind(this));
        },

        _setToken: function (val) {
          this._setContext(val);
          this.$.storage.value = this.token = CT.token = val;
          this.$.storage.save();
          if (val == null) {
            this._signedIn = false;
            this.fire('ct-sign-out');
          }
        },

        /**
         * Sign out the user
         */
        signOut: function() {
          this._setToken(null);
          window.location = [this.authHostUrl, '/sign-out', '?next=', encodeURIComponent(this.afterSignOutUrl)].join('');
        }
      });
    })();
  </script>

</dom-module>
