<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../ct-core-utils/ct-core.html">
<!--<link rel="import" href="../ct-user-api/ct-user-api.html">-->

<!--
`<ct-sign-in-button>` is used to authenticate with an API.
@demo
-->
<dom-module id="ct-sign-in-button">

  <template>
    <style>
      :host {
        display: block;
      }
      paper-button > iron-icon {
        margin-right: 0.4em;
      }
    </style>

    <template is="dom-if" if="{{ !signedIn }}">
      <paper-button on-tap="signIn">
        <iron-icon icon="cloud"></iron-icon> Sign In
      </paper-button>
    </template>

    <template is="dom-if" if="{{ signedIn }}">
      <paper-icon-button on-tap="signOut" icon="power-settings-new"></paper-icon-button>
    </template>

    <app-location route="{{ route }}"></app-location>
    <app-route route="[[ route ]]" pattern="/oauth" tail="{{ routeData }}"></app-route>

    <iron-localstorage
            id="storage"
            name="ct-auth"
            use-raw
            auto-save-disabled
            on-iron-localstorage-load="_localstorageLoaded"
            on-iron-localstorage-load-empty="_localstorageLoaded"
    ></iron-localstorage>

    <!--<ct-user-api id="usersAPI"></ct-user-api>-->

  </template>

  <script>
    (function () {
      var CT = window.CT;
      Polymer({
        is: 'ct-sign-in-button',

        /**
         * Fired when signed in.
         * @param {Object} detail The user object.
         * @event ct-sign-in
         */

        /**
         * Fired when there is an error during the signin flow.
         * @param {Object} detail The error object.
         * @event ct-sign-in-error
         */

        properties: {
          /**
           * Is the user signed in
           */
          signedIn: {
            type: Boolean,
            computed: '_computeSignedIn(user)',
            notify: true
          },
          /**
           * The signed in user
           */
          user: {
            type: Object,
            notify: true
          }
        },

        observers: [
          '_routeChanged(routeData)',
          '_authenticateUser(token)'
        ],

        /**
         * Sign in user. Redirects the user to authorization server for signing in.
         */
        signIn: function() {
          // TODO implement "state"
          window.location = [
            CT.authHost, 'oauth/authorise?response_type=token&client_id=', CT.authClientId,
            '&redirect_uri=', encodeURIComponent(window.location.origin + '/oauth')
          ].join('');
        },

        /**
         * Sign out the user
         */
        signOut: function() {
          this._setToken(null);
          this.fire('ct-sign-out');
        },

        _computeSignedIn: function(user) {
          return user !== null;
        },

        _routeChanged: function(routeData) {
          if (routeData.prefix !== '/oauth') {
            return;
          }

          if (routeData.__queryParams.access_token) {
            this._setToken(routeData.__queryParams.access_token);
          }

          // TODO handle errors

          window.history.pushState(null,'','/');
        },

        _authenticateUser: function(token) {
          if (!token) {
            this.user = null;
            return;
          }

          this.$.usersAPI.getLoggedInUser()
                  .then(function(request) {
                    this.user = request.response;
                    CT.userId = this.user.id;
                    this.fire('ct-sign-in', request.response);
                  }.bind(this))
                  .catch(ExpiredTokenError, function() {
                    this._setToken(null);
                    this.signIn();
                  }.bind(this))
                  .catch(function(error) {
                    this.fire('ct-sign-in-error', error);
                  }.bind(this));
        },

        _setToken: function (val) {
          this.$.storage.value = this.token = CT.token = val;
          this.$.storage.save();
        },

        _localstorageLoaded: function() {
          this._setToken(this.$.storage.value);
        }

      });
    })();
  </script>

</dom-module>
