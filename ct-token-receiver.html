<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="ct-user-identity.html">

<dom-module id="ct-token-receiver">
    <template>
        <app-location route="{{ route }}"></app-location>
        <app-route route="[[ route ]]" pattern="[[ _redirectPattern ]]" tail="{{ routeData }}"></app-route>
    </template>

    <script>
        Polymer({
            is: 'ct-token-receiver',
            behaviors:[CT.Behaviours.Identity],

            properties: {
                /**
                 * Token redirect uri you've registered for this client
                 */
                tokenRedirectUri: String
            },

            observers: [
                '_setRoutePattern(tokenRedirectUri)',
                '_routeChanged(routeData)'
            ],

            _setRoutePattern: function() {
                this._redirectPattern = new URL(this.tokenRedirectUri).pathname;
            },

            _routeChanged: function(routeData) {
                if (routeData.prefix !== this._redirectPattern) {
                    return;
                }
                if (routeData.__queryParams.access_token) {
                    var previousUser = CT.identity.userId;
                    this._setIdentity(routeData.__queryParams.access_token);
                    if (CT.identity.userId != previousUser) {
                        this.fire('ct-identity-changed', CT.identity);
                    }
                }
                // TODO handle errors
                if (CT.currentPage) {
                    window.history.pushState(null, '', CT.currentPage);
                }
            }
        });
    </script>
</dom-module>